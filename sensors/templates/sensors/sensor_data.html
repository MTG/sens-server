<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Data for {{ sensor_id }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/min/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.0.0"></script>
    <style>
        #chart-container {
            width: 80%;
            margin: auto;
            padding-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Real-time data for sensor: {{ sensor_id }}</h1>

    <div id="chart-container">
        <label for="timeRange">Select Time Range:</label>
        <select id="timeRange" onchange="newTimeRangeSelected()">
            <option value="1">Last Minute</option>
            <option value="10" selected>Last 10 Minutes</option>
            <option value="30">Last 30 Minutes</option>
            <option value="60">Last Hour</option>
            <option value="720">Last 12 Hours</option>
            <option value="1440">Last 24 Hours</option>
        </select>
        <button id="reset-zoom-button" disabled>Reset Zoom</button>
        <div id="sensorCharts"></div>
        <canvas id="sensorChart"></canvas>
    </div>

    <script type="text/javascript">
        const sensorId = "{{ sensor_id }}"; // Replace with the specific sensor ID or make it dynamic 
        const sensorChartsWrapper = document.getElementById('sensorCharts');
        const resetZoomButton = document.getElementById('reset-zoom-button');

        // Initialize Chart.js charts
        const sourcesChartCanvas = document.createElement('canvas');
        const isoChartCanvas = document.createElement('canvas');
        const leqChartCanvas = document.createElement('canvas');

        sensorChartsWrapper.appendChild(isoChartCanvas);
        sensorChartsWrapper.appendChild(sourcesChartCanvas);
        sensorChartsWrapper.appendChild(leqChartCanvas);

        // The ISO chart will contain timeseries for properties:
        // - Pleasantness
        // - Pleasantness Inst
        // - Eventfulness
        // - Eventfulness Inst
        const isoChart = new Chart(isoChartCanvas.getContext('2d'), {
            type: 'line',
            data: {
                datasets: [
                    { label: 'Pleasantness', data: [], borderColor: 'blue', fill: false },
                    { label: 'Pleasantness Inst', data: [], borderColor: 'darkBlue', fill: false, borderDash: [5, 1] },
                    { label: 'Eventfulness', data: [], borderColor: 'green', fill: false },
                    { label: 'Eventfulness Inst', data: [], borderColor: 'darkGreen', fill: false, borderDash: [5, 1] },
                ]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute'
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        min: -0.5,
                        max: 0.5,
                        title: {
                            display: true,
                            text: 'Value'
                        }
                    }
                },
                animation: {
                    duration: 0
                },
                plugins: {
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x',
                        },
                        zoom: {
                            wheel: {
                                enabled: true,
                                modifierKey: 'alt',
                                mode: 'x',
                            },
                            drag: {
                                enabled: true,
                            },
                            onZoom: function({chart}) {
                                // Stop real-time updates
                                isoChart.isZommed = true;
                                resetZoomButton.disabled = false;
                            },
                            onZoomStart: e => e.point.x > e.chart.chartArea.left && e.point.x < e.chart.chartArea.right && e.point.y > e.chart.chartArea.top && e.point.y < e.chart.chartArea.bottom
                        }
                    }
                }
            }
        });

        // The sources chart will contain timeseries for the automatically detected sound sources 
        // Possible sound sources include: ['birds', 'construction', 'dogs', 'human', 'music', 'nature', 'siren', 'vehicles']
        const sourcesChart = new Chart(sourcesChartCanvas.getContext('2d'), {
            type: 'line',
            data: {
                datasets: [
                    { label: 'Birds', data: [], borderColor: 'red', fill: false },
                    { label: 'Construction', data: [], borderColor: 'orange', fill: false },
                    { label: 'Dogs', data: [], borderColor: 'purple', fill: false },
                    { label: 'Human', data: [], borderColor: 'brown', fill: false },
                    { label: 'Music', data: [], borderColor: 'pink', fill: false },
                    { label: 'Nature', data: [], borderColor: 'gray', fill: false },
                    { label: 'Siren', data: [], borderColor: 'black', fill: false },
                    { label: 'Vehicles', data: [], borderColor: 'cyan', fill: false },
                ]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute'
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        min: 0,
                        max: 1,
                        title: {
                            display: true,
                            text: 'Value'
                        }
                    }
                },
                animation: {
                    duration: 0
                },
                plugins: {
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x',
                        },
                        zoom: {
                            wheel: {
                                enabled: true,
                                modifierKey: 'alt',
                                mode: 'x',
                            },
                            drag: {
                                enabled: true,
                            },
                            onZoom: function({chart}) {
                                // Stop real-time updates
                                sourcesChart.isZommed = true;
                                resetZoomButton.disabled = false;
                            },
                            onZoomStart: e => e.point.x > e.chart.chartArea.left && e.point.x < e.chart.chartArea.right && e.point.y > e.chart.chartArea.top && e.point.y < e.chart.chartArea.bottom
                        }
                    }
                }
            }
        });

        // Create chart for displaying Leq values
        const leqChart = new Chart(leqChartCanvas.getContext('2d'), {
            type: 'line',
            data: {
                datasets: [
                    { label: 'Leq', data: [], borderColor: 'blue', fill: false },
                    { label: 'LAeq', data: [], borderColor: 'red', fill: false },
                ]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute'
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        min: 40,
                        max: 90,
                        title: {
                            display: true,
                            text: 'dB'
                        }
                    }
                },
                animation: {
                    duration: 0
                },
                plugins: {
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x',
                        },
                        zoom: {
                            wheel: {
                                enabled: true,
                                modifierKey: 'alt',
                                mode: 'x',
                            },
                            drag: {
                                enabled: true,
                            },
                            onZoom: function({chart}) {
                                // Stop real-time updates
                                leqChart.isZommed = true;
                                resetZoomButton.disabled = false;
                            },
                            onZoomStart: e => e.point.x > e.chart.chartArea.left && e.point.x < e.chart.chartArea.right && e.point.y > e.chart.chartArea.top && e.point.y < e.chart.chartArea.bottom
                        }
                    }
                }
            }
        });

        function adjustChartTimeScale(chart) {
            const selectedRange = parseInt(document.getElementById("timeRange").value);
            const currentTime = new Date();
            const startTime = new Date(currentTime - selectedRange * 60 * 1000); // Convert minutes to milliseconds
            chart.options.scales.x.min = startTime;
            chart.options.scales.x.max = currentTime;
        }

        function resetChartsZoom() {
            resetZoomButton.disabled = true;
            isoChart.isZommed = false;
            sourcesChart.isZommed = false;
            leqChart.isZommed = false;
            isoChart.resetZoom();
            sourcesChart.resetZoom();
            leqChart.resetZoom();
            adjustChartTimeScale(isoChart);
            adjustChartTimeScale(sourcesChart)
            adjustChartTimeScale(leqChart);
            isoChart.update();
            sourcesChart.update();
            leqChart.update();
        }

        resetZoomButton.onclick = function() {
            resetChartsZoom();
        };
        
        // Function to fetch data and update the chart
        async function fetchSensorData() {

            // Define current start and end time
            const selectedRange = parseInt(document.getElementById("timeRange").value);
            const currentTime = new Date();
            const startTime = new Date(currentTime - selectedRange * 60 * 1000); // Convert minutes to milliseconds

            // Update chart time axis
            if (isoChart.isZommed !== true){
                adjustChartTimeScale(isoChart);
            }
            if (sourcesChart.isZommed !== true){
                adjustChartTimeScale(sourcesChart);
            }
            if (leqChart.isZommed !== true){
                adjustChartTimeScale(leqChart);
            }

            // Add "start_date" and "end_date" parameters to the apiUrl following this format: .../?start_date=2023-10-01T00:00:00Z&end_date=2025-10-10T23:59:59Z
            // API endpoint to get sensor data filtered by sensor ID and time range
            const apiUrl = "{{ api_endpoint_url }}" + sensorId + '/time-range/?start_date=' + startTime.toISOString() + '&end_date=' + currentTime.toISOString();
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                updateChart(data);
            } catch (error) {
                console.error("Error fetching sensor data:", error);
            }
        }

        // Function to update chart data
        function updateChart(data) {

            // Update isoChart data
            isoChart.data.datasets[0].data = [];
            isoChart.data.datasets[1].data = [];
            isoChart.data.datasets[2].data = [];
            isoChart.data.datasets[3].data = [];
            data.forEach(item => {
                const timestamp = new Date(item.sensor_timestamp);
                isoChart.data.datasets[0].data.push({ x: timestamp, y: item.data.pleasantness_intg });
                isoChart.data.datasets[1].data.push({ x: timestamp, y: item.data.pleasantness_inst });
                isoChart.data.datasets[2].data.push({ x: timestamp, y: item.data.eventfulness_intg });
                isoChart.data.datasets[3].data.push({ x: timestamp, y: item.data.eventfulness_inst });
            });
            isoChart.update();

            // Update sourcesChart data
            sourcesChart.data.datasets[0].data = [];
            sourcesChart.data.datasets[1].data = [];
            sourcesChart.data.datasets[2].data = [];
            sourcesChart.data.datasets[3].data = [];
            sourcesChart.data.datasets[4].data = [];
            sourcesChart.data.datasets[5].data = [];
            sourcesChart.data.datasets[6].data = [];
            sourcesChart.data.datasets[7].data = [];
            data.forEach(item => {
                const timestamp = new Date(item.sensor_timestamp);
                sourcesChart.data.datasets[0].data.push({ x: timestamp, y: item.data.sources.birds });
                sourcesChart.data.datasets[1].data.push({ x: timestamp, y: item.data.sources.construction });
                sourcesChart.data.datasets[2].data.push({ x: timestamp, y: item.data.sources.dogs });
                sourcesChart.data.datasets[3].data.push({ x: timestamp, y: item.data.sources.human });
                sourcesChart.data.datasets[4].data.push({ x: timestamp, y: item.data.sources.music });
                sourcesChart.data.datasets[5].data.push({ x: timestamp, y: item.data.sources.nature });
                sourcesChart.data.datasets[6].data.push({ x: timestamp, y: item.data.sources.siren });
                sourcesChart.data.datasets[7].data.push({ x: timestamp, y: item.data.sources.vehicles });
            });
            sourcesChart.update();

            // Update leqChart data
            leqChart.data.datasets[0].data = [];
            leqChart.data.datasets[1].data = [];
            data.forEach(item => {
                const timestamp = new Date(item.sensor_timestamp);
                leqChart.data.datasets[0].data.push({ x: timestamp, y: item.data.leq });
                leqChart.data.datasets[1].data.push({ x: timestamp, y: item.data.LAeq });
            });
            leqChart.update();
        }

        newTimeRangeSelected = function() {
            fetchSensorData();
            resetChartsZoom();
        }

        // When page loads, fetch sensor data
        fetchSensorData();

        // Fetch data every 5 seconds to get real-time updates
        setInterval(fetchSensorData, 5000);

    </script>
</body>
</html>